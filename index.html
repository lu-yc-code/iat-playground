<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>7-Block IAT (Arrow Keys, Two-Line Labels)</title>

  <!-- Local jsPsych -->
  <script src="jspsych/jspsych.js"></script>
  <script src="jspsych/plugin-html-keyboard-response.js"></script>
  <link rel="stylesheet" href="jspsych/jspsych.css" />

  <style>
    body { background:#000; color:#fff; margin:0; }

    /* Two-column category labels (left / right) */
    .iat-labels-2line{
      display:flex;
      justify-content:space-between;
      width:100%;
      padding:0 120px;
      font-size:26px;
      line-height:1.4;
      box-sizing:border-box;
    }
    .iat-label-block{
      display:flex;
      flex-direction:column;
      width:45%;
    }
    .iat-label-left{
      text-align:left;
      white-space:pre;
    }
    .iat-label-right{
      text-align:right;
      white-space:pre;
    }

    /* Central stimulus word */
    .iat-stim{
      margin-top:90px;
      text-align:center;
      font-size:44px;
      letter-spacing:0.5px;
    }

    /* Instruction screens */
    .iat-instruction{
      max-width:900px;
      margin:80px auto;
      text-align:center;
      font-size:20px;
      line-height:1.7;
      padding:0 18px;
      box-sizing:border-box;
    }

    /* Error feedback (red X) */
    .iat-error{
      margin-top:18px;
      text-align:center;
      font-size:42px;
      color:#ff4d4d;
      font-weight:700;
    }

    .iat-small{
      margin-top:18px;
      text-align:center;
      font-size:16px;
      opacity:0.85;
    }
  </style>
</head>

<body>
<script>
/* =========================================================
   0) Global configuration
   ========================================================= */

/*
 * Toggle visual error feedback.
 * false = no visual feedback (errors recorded in data only)
 * true  = show a brief red "X" after incorrect responses
 */
const SHOW_ERROR_FEEDBACK = false;

// Key mapping
const LEFT_KEY  = "ArrowLeft";
const RIGHT_KEY = "ArrowRight";

// Trial counts (standard 7-block IAT structure)
const N_B1 = 20;
const N_B2 = 20;
const N_B3 = 20;
const N_B4 = 40;  // critical
const N_B5 = 20;
const N_B6 = 20;
const N_B7 = 40;  // critical

// Error feedback duration (used only if SHOW_ERROR_FEEDBACK = true)
const ERROR_FEEDBACK_MS = 300;

// D-score trimming and penalty parameters
const MIN_RT = 300;
const MAX_RT = 10000;
const ERROR_PENALTY_MS = 600;

/* Category labels */
const LABELS = {
  b1_left:  "Flowers (←)",
  b1_right: "Insects (→)",

  b2_left:  "Pleasant (←)",
  b2_right: "Unpleasant (→)",

  comp_left_top:     "Flowers (←)",
  comp_left_bottom:  "Pleasant (←)",
  comp_right_top:    "Insects (→)",
  comp_right_bottom: "Unpleasant (→)",

  rev_left:  "Insects (←)",
  rev_right: "Flowers (→)",

  inc_left_top:      "Insects (←)",
  inc_left_bottom:   "Pleasant (←)",
  inc_right_top:     "Flowers (→)",
  inc_right_bottom:  "Unpleasant (→)",
};

/* =========================================================
   1) Stimulus sets
   ========================================================= */

const flowers = [
  "rose","lily","tulip","daisy","orchid","sunflower",
  "water lily","jasmine","lotus",
  "bluebell","tea rose","camellia",
  "daffodil","magnolia","hibiscus"
];

const insects = [
  "cockroach","mosquito","fly","ant","beetle","wasp",
  "spider","silverfish","caterpillar","hornet","dragonfly","ladybug",
  "stick insect","bedbug","roach","flea","worm","gnat"
];

const pleasant = [
  "happy","joyful","peaceful","lovely","wonderful","delightful",
  "cheerful","friendly","comforting","calm","pleasant","smiling",
  "kind","relaxed","warm","safe","nice","positive","sweet",
  "hopeful","enjoyable","bright","grateful"
];

const unpleasant = [
  "terrible","disgusting","awful","bad","horrible","ugly",
  "angry","sad","painful","hurtful","dirty","frightening",
  "scary","stressful","uncomfortable","unpleasant","mean",
  "upsetting","disturbing","annoying","anxious","fearful"
];

/* =========================================================
   2) Utility functions
   ========================================================= */

// Fisher–Yates shuffle
function shuffle(array){
  const arr = array.slice();
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// Random element from array
function choice(array){
  return array[Math.floor(Math.random() * array.length)];
}

// Read URL parameters (e.g., Prolific / Qualtrics IDs)
function getUrlParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

// Detect whether task is embedded in Qualtrics (iframe)
function isEmbeddedInQualtrics(){
  return (window.self !== window.top);
}

/* =========================================================
   3) HTML builders
   ========================================================= */

function labelsOneLine(leftText, rightText){
  return `
    <div class="iat-labels-2line">
      <div class="iat-label-block iat-label-left"><div>${leftText}</div></div>
      <div class="iat-label-block iat-label-right"><div>${rightText}</div></div>
    </div>
  `;
}

function labelsTwoLine(leftTop, leftBottom, rightTop, rightBottom){
  return `
    <div class="iat-labels-2line">
      <div class="iat-label-block iat-label-left">
        <div>${leftTop}</div><div>${leftBottom}</div>
      </div>
      <div class="iat-label-block iat-label-right">
        <div>${rightTop}</div><div>${rightBottom}</div>
      </div>
    </div>
  `;
}

function stimHtml(headerHtml, stimText, showErrorX){
  return `
    ${headerHtml}
    <div class="iat-stim">${stimText}</div>
    ${showErrorX ? `<div class="iat-error">X</div>` : ``}
  `;
}

/* =========================================================
   4) Send data to Qualtrics via postMessage
   ========================================================= */

function sendToQualtrics(payloadJson, dScore){
  window.parent.postMessage({
    type: "IAT_DATA",
    iat_data: payloadJson,
    iat_D: (isNaN(dScore) ? "" : String(dScore)),
    timestamp_utc: new Date().toISOString()
  }, "*");
}

/* =========================================================
   5) D-score computation (Greenwald et al.)
   ========================================================= */

function computeD(jsPsych){
  let trials = jsPsych.data.get().filter(t =>
    t.block_type === "compatible_practice" ||
    t.block_type === "compatible_test" ||
    t.block_type === "incompatible_practice" ||
    t.block_type === "incompatible_test"
  ).values();

  trials = trials.filter(t =>
    t.rt !== null && t.rt >= MIN_RT && t.rt <= MAX_RT
  );

  trials.forEach(t => {
    t.penalty_rt = t.rt + (t.correct ? 0 : ERROR_PENALTY_MS);
  });

  const comp = trials
    .filter(t => t.block_type.includes("compatible"))
    .map(t => t.penalty_rt);

  const incomp = trials
    .filter(t => t.block_type.includes("incompatible"))
    .map(t => t.penalty_rt);

  function mean(a){ return a.reduce((x,y)=>x+y,0) / a.length; }
  function sd(a){
    const m = mean(a);
    return Math.sqrt(a.reduce((s,x)=>s + (x - m) ** 2, 0) / (a.length - 1));
  }

  if(comp.length < 10 || incomp.length < 10) return NaN;

  const pooled = sd(comp.concat(incomp));
  if(!isFinite(pooled) || pooled === 0) return NaN;

  return (mean(incomp) - mean(comp)) / pooled;
}

/* =========================================================
   6) Trial factory (toggleable error feedback)
   ========================================================= */

function makeIatTrial(jsPsych, {
  headerHtml, stim, correctKey, blockNum, blockType, category
}){
  if (typeof window.__iat_error_count === "undefined") {
    window.__iat_error_count = 0;
  }

  const responseTrial = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: stimHtml(headerHtml, stim, false),
    choices: [LEFT_KEY, RIGHT_KEY],
    data: {
      block: blockNum,
      block_type: blockType,
      category: category,
      stimulus_label: stim,
      correct_key: correctKey,
      correct: null,
      is_error: null,
      error_count_total: null
    },
    on_finish: (d) => {
      const isCorrect = jsPsych.pluginAPI.compareKeys(d.response, d.correct_key);
      d.correct = isCorrect;
      d.is_error = !isCorrect;

      if (!isCorrect) window.__iat_error_count += 1;
      d.error_count_total = window.__iat_error_count;
    }
  };

  if (!SHOW_ERROR_FEEDBACK) {
    return responseTrial;
  }

  const errorTrial = {
    timeline: [{
      type: jsPsychHtmlKeyboardResponse,
      stimulus: stimHtml(headerHtml, stim, true),
      choices: "NO_KEYS",
      trial_duration: ERROR_FEEDBACK_MS,
      data: { feedback: "error_x" }
    }],
    conditional_function: () => {
      const last = jsPsych.data.get().last(1).values()[0];
      return last && last.correct === false;
    }
  };

  return { timeline: [responseTrial, errorTrial] };
}

/* =========================================================
   7–9) Timeline construction & execution
   ========================================================= */

const jsPsych = initJsPsych();
const timeline = [];

jsPsych.data.addProperties({
  prolific_pid: getUrlParam("PROLIFIC_PID"),
  study_id: getUrlParam("STUDY_ID"),
  session_id: getUrlParam("SESSION_ID")
});

/* (Blocks 1–7 and final submission are identical to previous version) */
/* jsPsych.run(timeline); */

</script>
</body>
</html>
